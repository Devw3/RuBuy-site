<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Мои заказы</title>
  <style>
    :root {
      --bg-color: #010103;
      --card-bg: #232325;
      --header-bg: #232325;
      --text-light: #dcdcde;
      --text-dark: #7b7a7a;
      --accent-red: #e53935;
      --border-color: #3a3a3c;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-light);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      text-align: center;
      margin: 20px 0 30px;
      color: var(--text-light);
      font-size: 2rem;
    }
    .orders-list {
      display: grid;
      grid-template-columns: 1fr;
      row-gap: 30px;
    }
    .order {
      background: var(--card-bg);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    .order-header {
      background: var(--header-bg);
      color: var(--text-light);
      padding: 15px 20px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .order-items {
      padding: 0 10px;
    }
    .order-item {
      display: flex;
      align-items: flex-start;
      padding: 20px 0;
      border-bottom: 1px solid var(--border-color);
      gap: 15px;
    }
    .order-item:last-child {
      border-bottom: none;
    }
    .item-image {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 6px;
      flex-shrink: 0;
    }
    .item-details {
      flex: 1;
    }
    .item-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-light);
      font-size: 1rem;
      text-decoration: none;
    }
    .item-variant,
    .item-quantity,
    .item-tracking {
      color: var(--text-light);
      margin-bottom: 5px;
      font-size: 0.9rem;
      opacity: 0.8;
    }
    .item-price {
      color: var(--text-light);
      font-weight: 600;
      margin-top: 10px;
    }
    .item-status {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      background: rgba(229, 57, 53, 0.1);
      color: var(--accent-red);
      align-self: center;
      margin-left: auto;
      white-space: nowrap;
    }
    .status-ordered { background: rgba(76, 175, 80, 0.1); color: #4CAF50; }
    .status-processing { background: rgba(255, 152, 0, 0.1); color: #FF9800; }
    .status-purchased { background: rgba(33, 150, 243, 0.1); color: #2196F3; }
    .status-seller_sent { background: rgba(63, 81, 181, 0.1); color: #3F51B5; }
    .status-in_transit { background: rgba(156, 39, 176, 0.1); color: #9C27B0; }
    .status-in_warehouse { background: rgba(76, 175, 80, 0.1); color: #4CAF50; }
    .status-delivered { background: rgba(103, 58, 183, 0.1); color: #673AB7; }
    .no-orders {
      text-align: center;
      padding: 50px 20px;
      background: var(--card-bg);
      border-radius: 12px;
      font-size: 1.1rem;
    }
    @media (max-width: 480px) {
      .order-item { gap: 7px; }
      .item-title { font-size: 10px; }
      .item-variant, .item-quantity, .item-tracking { font-size: 10px; margin-bottom: 0; }
      body { padding: 10px; }
      .item-image { width: 100px; height: 100px; }
      .item-price { font-size: 12px; }
      .item-status { margin-left: 0; margin-top: 10px; align-self: flex-start; }
    }
    .pay-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 3px 8px;
      border-radius: 3px;
      margin-left: 10px;
      cursor: pointer;
    }

    .paid-status {
      color: #28a745;
      margin-left: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Мои заказы</h1>

    {% if orders %}
    <div class="orders-list">
      {% for order in orders %}
      <div class="order">
        <div class="order-header">
          <span>Заказ №{{ order.id }}</span>
          <span>{{ order.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
        </div>

        <div class="order-items">
          {% for item in order['items'] %}
          <div class="order-item">
            <img src="{{ item.image_url or '' }}" alt="{{ item.product_title or '' }}" class="item-image">
            <div class="item-details">
              <div class="item-title">{{ item.product_title or 'Без названия' }}</div>
              <div class="item-variant">Цвет: {{ item.color or 'не указан' }}</div>
              <div class="item-variant">Размер: {{ item.size or 'не указан' }}</div>
              <div class="item-tracking">Трек-номер: <strong>{{ order.our_tracking_number or 'ожидается' }}</strong></div>
              <div class="item-quantity">Количество: {{ item.quantity or 0 }} шт.</div>
              <div class="item-price">
                {% if item.price is not none and item.quantity is not none %}
                  {{ "%.2f"|format(item.price) }} ¥ × {{ item.quantity }} = {{ "%.2f"|format(item.price * item.quantity) }} ¥
                {% else %}
                  Цена не указана
                {% endif %}
              </div>
              {% if order.cn_delivery_price and order.cn_delivery_price > 0 %}
                <div class="delivery-info">
                    <strong>Доставка по Китаю:</strong>
                    <span>{{ order.cn_delivery_price|float }} ¥</span>
                    
                    {% if not order.cn_delivery_paid %}
                        <button class="pay-btn" onclick="payDelivery({{ order.id }})">
                            Оплатить
                        </button>
                    {% else %}
                        <span class="paid-status">✓ Оплачено</span>
                    {% endif %}
                </div>
              {% endif %}
            </div>
            <div class="item-status status-{{ item.status or order.status }}">
              {% if item.status == 'ordered' %}Заказан{% endif %}
              {% if item.status == 'processing' %}В обработке{% endif %}
              {% if item.status == 'purchased' %}Выкуплен{% endif %}
              {% if item.status == 'seller_sent' %}Отправлен продавцом{% endif %}
              {% if item.status == 'in_transit' %}В пути{% endif %}
              {% if item.status == 'in_warehouse' %}На складе{% endif %}
            </div>
          </div>
          {% endfor %}
        </div><!-- /.order-items -->
      </div><!-- /.order -->
      {% endfor %}
    </div><!-- /.orders-list -->
    {% else %}
    <div class="no-orders">
      <p>У вас пока нет заказов.</p>
      <p><a href="/catalog" style="color: var(--accent-red); text-decoration: none;">Перейти в каталог →</a></p>
    </div>
    {% endif %}
  </div>
  <script>
    async function payDelivery(orderId) {
    if (!confirm(`Оплатить доставку для заказа #${orderId}?`)) return;
    
    try {
        const response = await fetch(`/pay_delivery/${orderId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(result.success);
            location.reload();
        } else {
            throw new Error(result.error || 'Ошибка оплаты');
        }
    } catch (error) {
        alert(error.message);
        console.error('Payment error:', error);
    }
}
  </script>
</body>
</html>
