<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–∏–Ω–∞–Ω—Å—ã - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
<style>
:root{
  /* ===== WHITE‚ÄìRED (light) ‚Äî high-contrast ===== */
  --bg:#ffffff;
  --panel:#ffffff;
  --panel-2:#fafafa;
  --text:#0b0d12;
  --muted:#5a5f6a;
  --brand:#dc2626;   /* red */
  --brand-2:#991b1b; /* deep red */
  --ok:#16a34a;
  --warn:#d97706;
  --bad:#dc2626;
  --border:#e6e7ee;
  --ring:#fecaca;
  --chip:#fff1f2;
  --chip-text:#7f1d1d;
  --table-stripe:#fff6f6;
  --link:#b91c1c;
  --head:#0b0d12;
}

@media (prefers-color-scheme: dark){
  /* –µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–∫–ª—é—á–µ–Ω–∞ —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞ ‚Äî –≤—Å—ë —Ä–∞–≤–Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º —Å–≤–µ—Ç–ª—É—é,
     —á—Ç–æ–±—ã –∞–¥–º–∏–Ω–∫–∞ –≤—Å–µ–≥–¥–∞ –±—ã–ª–∞ –±–µ–ª–æ-–∫—Ä–∞—Å–Ω–æ–π –∏ —á–∏—Ç–∞–±–µ–ª—å–Ω–æ–π */
  :root{
    --bg:#ffffff;
    --panel:#ffffff;
    --panel-2:#fafafa;
    --text:#0b0d12;
    --muted:#5a5f6a;
    --brand:#dc2626;
    --brand-2:#991b1b;
    --ok:#16a34a;
    --warn:#d97706;
    --bad:#dc2626;
    --border:#e6e7ee;
    --ring:#fecaca;
    --chip:#fff1f2;
    --chip-text:#7f1d1d;
    --table-stripe:#fff6f6;
    --link:#b91c1c;
    --head:#0b0d12;
  }
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--text);
  font:15px/1.6 Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}

/* ===== layout & header ===== */
.container,.admin-container{max-width:1280px;margin:28px auto;padding:0 18px}
.header,.admin-header{display:flex;align-items:flex-end;justify-content:space-between;margin:8px 0 20px}
.header .title,.admin-title{font-size:24px;font-weight:800;letter-spacing:.2px;color:var(--head)}
.header .subtitle{color:var(--muted);font-size:13px}

/* ===== links ===== */
a{color:var(--link);text-decoration:none}
a:hover{text-decoration:underline}

/* ===== tabs ===== */
.tabs{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px}
.tab-btn{
  background:var(--panel);color:var(--text);
  border:1px solid var(--border);padding:10px 14px;border-radius:12px;
  cursor:pointer;transition:.2s ease;font-weight:700;
}
.tab-btn:hover{transform:translateY(-1px);border-color:#f1a1a1;box-shadow:0 6px 18px -12px rgba(220,38,38,.18)}
.tab-btn.active{
  background:linear-gradient(180deg,var(--brand),var(--brand-2));
  border-color:transparent;color:#fff;box-shadow:0 10px 26px -12px rgba(220,38,38,.35)
}
.tab-content{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px;margin-bottom:16px}

/* ===== cards ===== */
.card{
  background:var(--panel);border:1px solid var(--border);
  border-radius:16px;padding:20px;box-shadow:0 12px 30px -20px rgba(0,0,0,.08);
}
.card h3{margin:0 0 14px;font-size:19px;color:var(--head)}
.card .muted{color:var(--muted)}

/* ===== tables ===== */
table{width:100%;border-collapse:separate;border-spacing:0}
thead th{
  position:sticky;top:0;z-index:1;background:var(--panel-2);
  color:#1a1c22;text-align:left;font-weight:900;
  font-size:12.5px;letter-spacing:.35px;text-transform:uppercase;
  padding:12px 14px;border-bottom:1px solid var(--border)
}
tbody td{padding:12px 14px;border-bottom:1px solid var(--border);vertical-align:top}
tbody tr:hover{background:#fff7f7}
.no-data,.error{color:var(--muted);text-align:center;padding:16px}

/* zebra for dense tables */
.shipments-table tbody tr:nth-child(odd){background:transparent}
.shipments-table tbody tr:nth-child(even){background:var(--table-stripe)}
.shipment-details-row td{background:var(--panel-2)!important;border-bottom:none}

/* –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —á–∏—Å–µ–ª */
td[data-th*="–í–µ—Å"], td[data-th*="–¶–µ–Ω–∞"], td[data-th*="CNY"], td[data-th*="USD"],
td:nth-child(5), td:nth-child(6){text-align:right;font-variant-numeric:tabular-nums}

/* ===== buttons ===== */
button,.btn{
  background:#fff;color:var(--text);
  border:1px solid var(--border);padding:10px 14px;border-radius:12px;
  font-weight:800;cursor:pointer;transition:.2s ease;user-select:none;
}
button:hover,.btn:hover{transform:translateY(-1px);border-color:#f1a1a1;box-shadow:0 10px 22px -18px rgba(220,38,38,.25)}
button:disabled{opacity:.6;cursor:not-allowed;transform:none;box-shadow:none}

.btn-approve{background:#ecfdf5;border-color:#bbf7d0;color:#047857}
.btn-reject{background:#fef2f2;border-color:#fecaca;color:#b91c1c}
.btn-details,.btn-show-shipment-details{background:#fff1f2;color:#7f1d1d;border-color:#ffe4e6}
.btn-primary,.btn-set-packaging,.btn-set-status,.btn-save-status,.btn-save-weight,.btn-save-cn-price{
  background:linear-gradient(180deg,var(--brand),var(--brand-2));
  border-color:transparent;color:#fff
}

/* ===== inputs / selects ===== */
input[type="text"],input[type="number"],input[type="search"],input[type="url"],textarea,select{
  width:100%;max-width:520px;background:#ffffff;color:var(--text);
  border:1px solid var(--border);border-radius:12px;padding:10px 12px;outline:none;transition:.2s ease;
  box-shadow:inset 0 1px 0 rgba(0,0,0,.02);
}
input::placeholder,textarea::placeholder{color:#8b90a0}
textarea{min-height:120px}
input:focus,textarea:focus,select:focus{border-color:#ef9a9a;box-shadow:0 0 0 4px rgba(220,38,38,.15)}
select{max-width:360px}
.packaging-input{max-width:180px}

/* –≥—Ä—É–ø–ø–æ–≤—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª—ã (–ø–æ–ª–µ + –∫–Ω–æ–ø–∫–∞) */
.input-group{display:flex;align-items:center}
.input-group > input{border-right:none;border-radius:12px 0 0 12px}
.input-group > .btn{border-radius:0 12px 12px 0}

/* ===== badges / status ===== */
.badge{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:999px;font-size:12.5px;border:1px solid var(--border);background:#fff7f7;color:#7f1d1d}
.badge-paid{background:#ecfdf5;color:#047857;border-color:#bbf7d0;padding:4px 10px;border-radius:999px;font-weight:900}
.badge-unpaid{background:#fff7ed;color:#b45309;border-color:#fed7aa;padding:4px 10px;border-radius:999px;font-weight:900}

.status-pending{color:#6b7280}
.status-processing{color:#dc2626}
.status-packed{color:#c2410c}
.status-in_transit,.status-shipped{color:#b45309}
.status-delivered{color:#047857}
.status-canceled{color:#991b1b}

/* ===== photo grids / thumbnails ===== */
.photo-list{display:flex;flex-wrap:wrap;gap:10px}
.photo-item{position:relative}
.photo-item img{border-radius:12px;border:1px solid var(--border);max-width:160px;max-height:160px}
.btn-remove-photo{position:absolute;top:6px;right:6px}

/* ===== modals (single + grid) ===== */
#photoModal,#photoGridModal{
  display:none; position:fixed; inset:0; z-index:1000;
  background:rgba(0,0,0,.45); backdrop-filter: blur(2px);
}
.modal-inner{
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  background:var(--panel); border:1px solid var(--border); border-radius:18px;
  padding:16px; width:min(96vw,1100px); max-height:90vh; overflow:auto;
  box-shadow:0 28px 70px -28px rgba(0,0,0,.2)
}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.modal-title{font-weight:900;color:var(--head)}
.modal-actions{display:flex;align-items:center;gap:10px}
.modal-actions .btn{padding:8px 12px}
#modalPhoto{max-width:100%;max-height:70vh;border-radius:14px;transition:opacity .08s ease}

/* ===== toolbars / filters ===== */
.toolbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:10px 0 16px}
.filter-btn{background:transparent;border:1px dashed var(--border);color:var(--muted)}
.filter-btn.active{background:#fff1f2;color:#7f1d1d;border-style:solid}

/* ===== utilities ===== */
.row{display:flex;gap:14px;flex-wrap:wrap}
.space-between{display:flex;justify-content:space-between;align-items:center}
.mt-8{margin-top:8px}.mt-12{margin-top:12px}.mt-16{margin-top:16px}.mt-20{margin-top:20px}
.p-8{padding:8px}.p-12{padding:12px}.p-16{padding:16px}
.round{border-radius:12px}
hr{border:0;border-top:1px solid var(--border);margin:14px 0}

/* ===== responsive (stacked table on mobile) ===== */
@media (max-width:980px){
  thead{display:none}
  table, tbody, tr, td {display:block;width:100%}
  tbody tr{margin-bottom:12px;border:1px solid var(--border);border-radius:14px;overflow:hidden;background:#fff}
  tbody td{display:flex;justify-content:space-between;gap:12px;padding:12px 14px}
  tbody td:before{content:attr(data-th);color:var(--muted);font-weight:800}
  .shipment-details-row td{padding:0}
  .shipment-details{padding:14px}
}

/* ===== OVERRIDES for photo upload instructions ===== */
.photo-upload-box > div:first-child{
  background:var(--panel-2) !important;
  color:var(--text) !important;
  border:1px solid var(--border) !important;
  border-radius:14px !important;
}
.photo-upload-box > div:first-child ol,
.photo-upload-box > div:first-child p,
.photo-upload-box > div:first-child strong{color:var(--text) !important}
.photo-upload-box > div:first-child a{color:var(--link) !important}

.photo-upload-box .photo-url-input{
  background:#ffffff !important;color:var(--text) !important;
  border:1px solid var(--border) !important;border-right:none !important;
  border-radius:12px 0 0 12px !important;
}
.photo-upload-box .btn-add-photo{
  background:linear-gradient(180deg,var(--brand),var(--brand-2)) !important;
  color:#fff !important;border:none !important;border-radius:0 12px 12px 0 !important;
  padding:10px 16px !important;
}

/* —á—Ç–æ–±—ã –≤–ª–æ–∂–µ–Ω–Ω—ã–µ div —Å inline-—Å—Ç–∏–ª—è–º–∏ –Ω–µ –±–µ–ª–µ–ª–∏ –±–µ–∑ –≥—Ä–∞–Ω–∏—Ü */
.photo-upload-box div { background:var(--panel-2) !important; border:1px solid var(--border) !important; border-radius:12px !important; padding:10px !important }

/* –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –ø–æ–ª–µ–π –≤ –¥–µ—Ç–∞–ª—è—Ö –∑–∞–∫–∞–∑–∞/–ø–æ—Å—ã–ª–∫–∏ */
.order-details-row{background:var(--panel-2)!important}
.order-details .detail-item{margin:6px 0}
.shipment-status-admin .detail-label, .packaging-admin .detail-label{color:var(--muted)}

/* ===== helpers for readability ===== */
.small-muted{font-size:12px;color:var(--muted)}
.kbd{background:#fff;border:1px solid var(--border);padding:2px 6px;border-radius:6px;font-weight:800}
.code{background:#fff;border:1px solid var(--border);padding:2px 6px;border-radius:6px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
</style>
</head>
<body>
    <div class="admin-container">
        <header class="admin-header">
            <h1 class="admin-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏</h1>
        </header>

        <div class="tabs">
            <button class="tab-btn active" data-tab="replenishments">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏—è</button>
            <button class="tab-btn" data-tab="withdrawals">–í—ã–≤–æ–¥—ã</button>
            <button class="tab-btn" data-tab="orders">–ó–∞–∫–∞–∑—ã</button>
            <button class="tab-btn" data-tab="shipments">–ü–æ—Å—ã–ª–∫–∏</button>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π -->
        <div id="replenishments-tab" class="tab-content">
            <div class="card">
                <div class="loading" id="loading-replenishments">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                
                <table class="replenishments-table" id="replenishments-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–°—É–º–º–∞</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="replenishments-body">
                        {% for replenishment in replenishments %}
                        <tr data-id="{{ replenishment.id }}">
                            <td>{{ replenishment.id }}</td>
                            <td>{{ replenishment.user_name }}</td>
                            <td>{{ "%.2f"|format(replenishment.amount_rub) }} ‚ÇΩ</td>
                            <td>{{ replenishment.payment_date }}</td>
                            <td class="status-{{ replenishment.status }}">
                                {{ '–û–∂–∏–¥–∞–µ—Ç' if replenishment.status == 'pending' else 
                                '–û–¥–æ–±—Ä–µ–Ω–æ' if replenishment.status == 'approved' else 
                                '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ' }}
                            </td>
                            <td>
                                {% if replenishment.status == 'pending' %}
                                <button class="action-btn btn-approve" data-id="{{ replenishment.id }}">
                                    <span>‚úì</span> –û–¥–æ–±—Ä–∏—Ç—å
                                </button>
                                <button class="action-btn btn-reject" data-id="{{ replenishment.id }}">
                                    <span>‚úó</span> –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                </button>
                                {% endif %}
                                <a href="{{ url_for('static', filename='uploads/' + replenishment.receipt_path.split('/')[-1]) }}" 
                                   class="btn-view" target="_blank">
                                    <span>üëÅÔ∏è</span> –ß–µ–∫
                                </a>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="no-data">–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –∑–∞—è–≤–æ–∫</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –≤—ã–≤–æ–¥–æ–≤ -->
        <div id="withdrawals-tab" class="tab-content" style="display: none;">
            <div class="card">
                <table class="withdrawals-table" id="withdrawals-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–°—É–º–º–∞</th>
                            <th>–†–µ–∫–≤–∏–∑–∏—Ç—ã</th>
                            <th>–ò–º—è</th>
                            <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawals-body">
                        {% for withdrawal in withdrawals %}
                        <tr data-id="{{ withdrawal.id }}">
                            <td>{{ withdrawal.id }}</td>
                            <td>{{ withdrawal.user_name }}</td>
                            <td>{{ "%.2f"|format(withdrawal.amount) }} ¬•</td>
                            <td>**** {{ withdrawal.card_last_four }}</td>
                            <td>{{ withdrawal.name }}</td>
                            <td>{{ withdrawal.created_at.strftime('%Y-%m-%d %H:%M') if withdrawal.created_at else '' }}</td>
                            <td class="status-{{ withdrawal.status }}">
                                {{ '–û–∂–∏–¥–∞–µ—Ç' if withdrawal.status == 'pending' else 
                                '–û–¥–æ–±—Ä–µ–Ω–æ' if withdrawal.status == 'approved' else 
                                '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ' }}
                            </td>
                            <td>
                                {% if withdrawal.status == 'pending' %}
                                <button class="action-btn btn-approve" data-id="{{ withdrawal.id }}">
                                    –û–¥–æ–±—Ä–∏—Ç—å
                                </button>
                                <button class="action-btn btn-reject" data-id="{{ withdrawal.id }}">
                                    –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="8" class="no-data">–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –∑–∞—è–≤–æ–∫</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –∑–∞–∫–∞–∑–æ–≤ -->
        <div id="orders-tab" class="tab-content" style="display: none;">
        <div class="card">
            <h3>–í—Å–µ –∑–∞–∫–∞–∑—ã ({{ orders|length }})</h3>
            <table class="orders-table">
            <thead>
                <tr>
                <th>ID</th>
                <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
                <th>–¢—Ä–µ–∫-–Ω–æ–º–µ—Ä</th>
                <th>–°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä</th>
                <th>–¢–æ–≤–∞—Ä</th>
                <th>–ö–æ–ª-–≤–æ</th>
                <th>–°—É–º–º–∞</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <!-- summary-—Å—Ç—Ä–æ–∫–∞ -->
                <tr class="order-summary" data-id="{{ order.id }}" style="cursor: pointer;">
                <td>#{{ order.id }}</td>
                <td>{{ order.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                <td>{{ order.our_tracking_number or '‚Äî' }}</td>
                <td>{{ order.url }}</td>
                <td>{{ order.product_title }}</td>
                <td>{{ order.quantity }}</td>
                <td>{{ "%.2f"|format(order.total_price | default(0)) }}</td>
                </tr>
                <!-- —Å–∫—Ä—ã—Ç–∞—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è -->
                <tr class="order-details-row" data-id="{{ order.id }}" style="display: none; background-color: var(--light-gray);">
                <td colspan="7">
                    <div class="order-details order-details-grid">
                    <div class="detail-item"><strong>–¶–≤–µ—Ç:</strong> {{ order.color }}</div>
                    <div class="detail-item"><strong>–†–∞–∑–º–µ—Ä:</strong> {{ order.size }}</div>
                    {% if order.china_tracking_number %}
                    <div class="detail-item"><strong>China-—Ç—Ä–µ–∫:</strong> {{ order.china_tracking_number }}</div>
                    {% endif %}
                    {% if order.warehouse_location %}
                    <div class="detail-item"><strong>–°–∫–ª–∞–¥:</strong> {{ order.warehouse_location }}</div>
                    {% endif %}
                    {% if order.additional_services_list %}
                        <div class="detail-item" style="grid-column: span 2;">
                            <strong>–î–æ–ø. —É—Å–ª—É–≥–∏:</strong>
                            <ul>
                                {% for svc in order.additional_services_list %}
                                <li>
                                    {% if svc == 'photos' %}–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–æ—Ç–æ{% endif %}
                                    {% if svc == 'video' %}–í–∏–¥–µ–æ–æ—Ç—á—ë—Ç{% endif %}
                                    {% if svc == 'inspection' %}–¢—á–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞{% endif %}
                                </li>
                                {% endfor %}    
                            </ul>
                        </div>  
                    {% endif %}
                    </div>

                    <!-- –í –±–ª–æ–∫–µ –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞ -->
                    <div class="detail-item" style="grid-column: span 2;">
                        <strong>–°—Ç–∞—Ç—É—Å:</strong>
                        <select class="status-select" data-order-id="{{ order.id }}">
                            <option value="processing" {% if order.status == 'ordered' %}selected{% endif %}>–ü–µ—Ä–µ–¥–∞–Ω–æ –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É</option>
                            <option value="purchased" {% if order.status == 'purchased' %}selected{% endif %}>–í—ã–∫—É–ø–ª–µ–Ω–æ</option>
                            <option value="seller_sent" {% if order.status == 'seller_sent' %}selected{% endif %}>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—Ä–æ–¥–∞–≤—Ü–æ–º</option>
                            <option value="in_transit" {% if order.status == 'in_transit' %}selected{% endif %}>–í –ø—É—Ç–∏</option>
                            <option value="in_warehouse" {% if order.status == 'in_warehouse' %}selected{% endif %}>–ù–∞ —Å–∫–ª–∞–¥–µ</option>
                        </select>
                        <button class="btn-save-status" data-order-id="{{ order.id }}">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>

                    <div class="detail-item" style="grid-column: span 2; margin-top: 10px;">
                        <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ –ø–æ –ö–∏—Ç–∞—é (¬•):</strong>
                        <input 
                            type="number" 
                            class="cn-delivery-price-input" 
                            data-order-id="{{ order.id }}"
                            min="0" 
                            step="0.01" 
                            placeholder="0.00"
                            value="{{ order.cn_delivery_price or '' }}"
                            style="width: 100px;"
                        >
                    </div>
                    <div class="detail-item" style="grid-column: span 2; margin-top: 10px;">
                        <button class="btn-save-cn-price" data-order-id="{{ order.id }}">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>

                    <!-- –ü–æ—Å–ª–µ –±–ª–æ–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –ø–æ –ö–∏—Ç–∞—é -->
                    <div class="detail-item" style="grid-column: span 2; margin-top: 10px;">
                        <strong>–í–µ—Å —Ç–æ–≤–∞—Ä–∞ (–∫–≥):</strong>
                        <input 
                            type="number" 
                            class="weight-input" 
                            data-order-id="{{ order.id }}"
                            min="0" 
                            step="0.01" 
                            placeholder="0.00"
                            value="{{ order.weight or '' }}"
                            style="width: 100px;"
                        >
                    </div>
                    <div class="detail-item" style="grid-column: span 2; margin-top: 10px;">
                        <button class="btn-save-weight" data-order-id="{{ order.id }}">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–µ—Å</button>
                    </div>

                    <!-- <div class="detail-item" style="grid-column: span 2; margin-top: 10px;">
                        <strong>–í–µ—Å —Ç–æ–≤–∞—Ä–∞:</strong>
                        {% if order.weight %}
                            <span>{{ "%.2f"|format(order.weight) }} –∫–≥</span>
                        {% else %}
                            <span style="color: #d9534f;">–ù–µ —É–∫–∞–∑–∞–Ω</span>
                        {% endif %}
                    </div> -->

                    <div class="detail-item" style="grid-column: span 2; margin-top: 10px;">
                        <strong>–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã –¥–æ—Å—Ç–∞–≤–∫–∏:</strong>
                        {% if order.cn_delivery_paid %}
                            <span style="color: green; font-weight: bold;">–û–ø–ª–∞—á–µ–Ω–æ</span>
                            <span>({{ "%.2f"|format(order.cn_delivery_price) }} ¬•)</span>
                        {% else %}
                            {% if order.cn_delivery_price and order.cn_delivery_price > 0 %}
                                <span style="color: #d9534f; font-weight: bold;">–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</span>
                                <button class="btn-pay-delivery" 
                                        data-order-id="{{ order.id }}"
                                        data-price="{{ order.cn_delivery_price }}">
                                    –û–ø–ª–∞—Ç–∏—Ç—å {{ "%.2f"|format(order.cn_delivery_price) }} ¬•
                                </button>
                            {% else %}
                                <span>–û–∂–∏–¥–∞–µ—Ç —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏</span>
                            {% endif %}
                        {% endif %}
                    </div>
                    <div class="photo-upload-box" data-order-id="{{ order.id }}">
                        <h4>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Ç–æ–≤–∞—Ä–∞</h4>
                        
                        <div style="margin-bottom: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <p><strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong></p>
                            <ol style="margin-left: 20px; margin-bottom: 15px;">
                                <li>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ <a href="https://freeimage.host/" target="_blank">FreeImage.Host</a></li>
                                <li>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Ç–æ–≤–∞—Ä–∞</li>
                                <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</li>
                                <li>–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –≤ –ø–æ–ª–µ –Ω–∏–∂–µ</li>
                            </ol>
                            
                            <!-- –ü–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ —Å—Å—ã–ª–∫–∏ -->
                            <div style="display: flex;">
                                <input type="text" class="photo-url-input" 
                                    placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–æ—Ç–æ" 
                                    style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px 0 0 4px;">
                                <button class="btn-add-photo" data-order-id="{{ order.id }}"
                                        style="padding: 8px 15px; background: #4CAF50; color: white; border: none; border-radius: 0 4px 4px 0;">
                                    –î–æ–±–∞–≤–∏—Ç—å
                                </button>
                            </div>
                        </div>
                        
                        <!-- –°–ø–∏—Å–æ–∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π -->
                        <div class="photo-list" data-order-id="{{ order.id }}">
                            {% if order.photos %}
                                {% for photo_url in order.photos %}
                                    <div class="photo-item" data-url="{{ photo_url }}">
                                        <img src="{{ photo_url }}" alt="–§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞" style="max-width: 150px; max-height: 150px; margin: 5px; border: 1px solid #ddd;">
                                        <button class="btn-remove-photo" data-url="{{ photo_url }}" data-order-id="{{ order.id }}" style="background: #ff4d4d; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer;">
                                            √ó
                                        </button>
                                    </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </td>
                </tr>
                {% else %}
                <tr><td colspan="7" class="no-data">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</td></tr>
                
                {% endfor %}
            </tbody>
            </table>
        </div>
        </div>


        <!-- –í–∫–ª–∞–¥–∫–∞ –ø–æ—Å—ã–ª–æ–∫ -->
        <div id="shipments-tab" class="tab-content" style="display: none;">
        <div class="card">
            <h3 style="display:flex;align-items:center;gap:10px;">
            –ü–æ—Å—ã–ª–∫–∏ ({{ shipments|length if shipments is defined else 0 }})
            <!-- <button id="btn-refresh-packaging" class="btn-details" type="button" title="–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã —É–ø–∞–∫–æ–≤–∫–∏">‚ü≥ –û–±–Ω–æ–≤–∏—Ç—å</button> -->
            </h3>

            <table class="shipments-table" style="width:100%; border-collapse: collapse;">
            <thead>
                <tr>
                <th>ID</th>
                <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
                <th>–¢—Ä–µ–∫ –ø–æ—Å—ã–ª–∫–∏</th>
                <th>–¢—Ä–µ–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ / Orders</th>
                <th>–í–µ—Å (–∫–≥)</th>
                <th>–¢–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–£–ø–∞–∫–æ–≤–∫–∞</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% if shipments %}
                {% for s in shipments %}
                <tr class="shipment-summary" data-id="{{ s.id }}" style="cursor: pointer;">
                    <td>#{{ s.id }}</td>
                    <td>{{ s.created_at.strftime('%d.%m.%Y %H:%M') if s.created_at else '' }}</td>
                    <td>{{ s.our_tracking_number or '‚Äî' }}</td>

                    <!-- –ö—Ä–∞—Ç–∫–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º order ids -->
                    <td>
                    {% set mids = s.get('model_ids') %}
                    {% if mids is iterable %}
                        {{ mids | join(', ') }}
                    {% elif mids %}
                        {{ mids }}
                    {% else %}
                        ‚Äî
                    {% endif %}
                    </td>

                    <td>{{ "%.2f"|format(s.total_weight) if s.total_weight is not none else '‚Äî' }}</td>
                    <td>{{ s.delivery_method or '‚Äî' }}</td>

                    <td id="status-summary-{{ s.id }}">
                        {% set _st = s.status or 'pending' %}
                        {% if _st == 'pending' %}–û–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏
                        {% elif _st == 'processing' %}–í –æ–±—Ä–∞–±–æ—Ç–∫–µ
                        {% elif _st == 'shipped' %}–í –ø—É—Ç–∏
                        {% elif _st == 'delivered' %}–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ
                        {% else %}{{ _st }}{% endif %}
                    </td>

                    <!-- –ö—Ä–∞—Ç–∫–∏–π —Å—Ç–∞—Ç—É—Å —É–ø–∞–∫–æ–≤–∫–∏ (—Å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º) -->
                    <td id="pkg-summary-{{ s.id }}">
                    {% if s.packaging_cost and s.packaging_cost > 0 %}
                        <span class="pkg-amount" data-amount="{{ '%.2f'|format(s.packaging_cost) }}">{{ "%.2f"|format(s.packaging_cost) }} CNY</span>
                        {% if s.packaging_paid %}
                        <span class="badge-paid">–û–ø–ª–∞—á–µ–Ω–æ</span>
                        {% else %}
                        <span class="badge-unpaid">–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</span>
                        {% endif %}
                    {% else %}
                        ‚Äî
                    {% endif %}
                    </td>

                    <td>
                    <button class="btn-show-shipment-details" data-id="{{ s.id }}">–î–µ—Ç–∞–ª–∏</button>
                    </td>
                </tr>

                <!-- —Å–∫—Ä—ã—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ —Å –¥–µ—Ç–∞–ª—è–º–∏ -->
                <tr class="shipment-details-row" data-id="{{ s.id }}" style="display:none; background:#f6f6f6;">
                    <td colspan="8">
                    <div class="shipment-details" style="padding:12px;">
                        <!-- –°–æ–∑–¥–∞—Ç–µ–ª—å -->
                        <div style="margin-bottom:10px;">
                        <strong>–°–æ–∑–¥–∞–ª –ø–æ—Å—ã–ª–∫—É (creator):</strong>
                        {% if s.creator %}
                            <div>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{ s.creator.username }} (ID: {{ s.creator.id }})</div>
                            <div>–¢–µ–ª–µ—Ñ–æ–Ω: {{ s.creator.phone or '‚Äî' }}, Email: {{ s.creator.email or '‚Äî' }}</div>
                        {% else %}
                            <div>‚Äî</div>
                        {% endif %}
                        </div>

                        <!-- –ü–æ–ª—É—á–∞—Ç–µ–ª—å -->
                        <div style="margin-bottom:10px;">
                        <strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å / –∞–¥—Ä–µ—Å:</strong>
                        <div>{{ s.recipient_name or '‚Äî' }}</div>
                        <div>{{ s.recipient_phone or '‚Äî' }}</div>
                        <div>{{ s.recipient_city or '‚Äî' }}, {{ s.recipient_address or '‚Äî' }}</div>
                        </div>

                        <!-- –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
                        <div style="overflow-x:auto; margin-top:12px;">
                        <table style="width:100%; border-collapse: collapse; font-size: 13px;">
                            <thead>
                            <tr style="background:#e9ecef;">
                                <th style="padding:8px; text-align:left;">Order ID</th>
                                <th style="padding:8px; text-align:left;">Model ID</th>
                                <th style="padding:8px; text-align:left;">–¢–æ–≤–∞—Ä</th>
                                <th style="padding:8px; text-align:right;">–ö–æ–ª-–≤–æ</th>
                                <th style="padding:8px; text-align:right;">–í–µ—Å (–∫–≥)</th>
                                <th style="padding:8px; text-align:right;">–¶–µ–Ω–∞</th>
                                <th style="padding:8px; text-align:left;">–ù–∞—à —Ç—Ä–µ–∫</th>
                                <th style="padding:8px; text-align:left;">CN —Ç—Ä–µ–∫</th>
                                <th style="padding:8px; text-align:left;">–ü–æ–∫—É–ø–∞—Ç–µ–ª—å (–∫–æ–Ω—Ç–∞–∫—Ç—ã)</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% set items = s.get('items') %}
                            {% if items %}
                                {% for it in items %}
                                <tr>
                                <td>{{ it.order_id or '‚Äî' }}</td>
                                <td>{{ it.model_id or '‚Äî' }}</td>
                                <td>{{ it.product_title or '‚Äî' }}</td>
                                <td style="text-align:right;">{{ it.quantity or '‚Äî' }}</td>
                                <td style="text-align:right;">{{ "%.2f"|format(it.weight) if it.weight is not none else '‚Äî' }}</td>
                                <td style="text-align:right;">{{ "%.2f"|format(it.price) if it.price is not none else '‚Äî' }}</td>
                                <td>{{ it.our_tracking_number or '‚Äî' }}</td>
                                <td>{{ it.china_tracking_number or '‚Äî' }}</td>
                                <td>
                                    {% if it.buyer %}
                                    {{ it.buyer.name or '‚Äî' }} {{ it.buyer.phone or '' }}
                                    {% else %} ‚Äî {% endif %}
                                </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                <td colspan="9">
                                    {% set mids = s.get('model_ids') %}
                                    {% if mids is iterable %}
                                    {{ mids | join(', ') }}
                                    {% else %}
                                    {{ mids or '‚Äî' }}
                                    {% endif %}
                                </td>
                                </tr>
                            {% endif %}
                            </tbody>
                        </table>
                        </div>

                        <!-- –ë–ª–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É–ø–∞–∫–æ–≤–∫–æ–π (–∞–¥–º–∏–Ω) -->
                        <div class="packaging-admin" style="margin-top:14px; display:flex; align-items:center; gap:10px;">
                            <span class="detail-label" style="min-width:140px; font-weight:600;">–£–ø–∞–∫–æ–≤–∫–∞ (CNY):</span>
                            <input
                                type="number"
                                class="packaging-input"
                                step="0.01"
                                min="0"
                                value="{{ "%.2f"|format(s.packaging_cost) if s.packaging_cost is not none else '' }}"
                                placeholder="0.00"
                                data-shipment-id="{{ s.id }}"
                                id="pkg-input-{{ s.id }}"
                                {% if s.packaging_paid %}disabled{% endif %}
                                style="width:140px;padding:6px 8px;border:1px solid #ddd;border-radius:6px;"
                            >
                            <span id="pkg-badge-{{ s.id }}">
                                {% if s.packaging_cost and s.packaging_cost > 0 %}
                                {% if s.packaging_paid %}
                                    <span class="badge-paid">–û–ø–ª–∞—á–µ–Ω–æ</span>
                                {% else %}
                                    <span class="badge-unpaid">–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</span>
                                {% endif %}
                                {% endif %}
                            </span>
                            {% if s.packaging_paid %}
                                <!-- —É–∂–µ –æ–ø–ª–∞—á–µ–Ω–æ, –∫–Ω–æ–ø–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞ -->
                            {% else %}
                                <button
                                class="btn-set-packaging"
                                id="btn-set-packaging-{{ s.id }}"
                                data-url="{{ url_for('admin_set_packaging', shipment_id=s.id) }}"
                                data-shipment-id="{{ s.id }}"
                                type="button"
                                >–í—ã—Å—Ç–∞–≤–∏—Ç—å —Å—á—ë—Ç</button>
                            {% endif %}

                            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–º –ø–æ—Å—ã–ª–∫–∏ (–∞–¥–º–∏–Ω) -->
                            <div class="shipment-status-admin" style="margin-top:14px; display:flex; align-items:center; gap:10px;">
                                <span class="detail-label" style="min-width:140px; font-weight:600;">–°—Ç–∞—Ç—É—Å –ø–æ—Å—ã–ª–∫–∏:</span>

                                <select
                                    id="status-select-{{ s.id }}"
                                    class="status-select"
                                    data-shipment-id="{{ s.id }}"
                                    style="min-width:220px;padding:6px 8px;border:1px solid #ddd;border-radius:6px;"
                                >
                                    <option value="pending"    {{ 'selected' if s.status == 'pending' else '' }}>–û–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏</option>
                                    <option value="processing" {{ 'selected' if s.status == 'processing' else '' }}>–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
                                    <option value="shipped"    {{ 'selected' if s.status == 'shipped' else '' }}>–í –ø—É—Ç–∏</option>
                                    <option value="delivered"  {{ 'selected' if s.status == 'delivered' else '' }}>–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</option>
                                </select>

                                <button
                                    class="btn-set-status"
                                    id="btn-set-status-{{ s.id }}"
                                    data-shipment-id="{{ s.id }}"
                                    data-url="/admin/shipments/{{ s.id }}/status"
                                    type="button"
                                    style="background:#111827;color:#fff;border:none;border-radius:8px;padding:8px 12px;font-weight:600;cursor:pointer;"
                                >
                                    –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
                                </button>

                                <span id="status-hint-{{ s.id }}" style="font-size:12px;color:#6b7280;"></span>
                            </div>

                        </div>

                        <!-- –ü—Ä–æ—á–∞—è –∏–Ω—Ñ–∞ -->
                        <div style="margin-top:12px;">
                        <strong>–í–µ—Å –ø–æ—Å—ã–ª–∫–∏:</strong> {{ "%.2f"|format(s.total_weight) if s.total_weight is not none else '‚Äî' }} –∫–≥<br>
                        <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏:</strong> {{ "%.2f"|format(s.delivery_cost) if s.delivery_cost is not none else '‚Äî' }} <br>
                        <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å —É–ø–∞–∫–æ–≤–∫–∏:</strong> <span id="pkg-amount-{{ s.id }}">{{ "%.2f"|format(s.packaging_cost) if s.packaging_cost is not none else '‚Äî' }}</span> <br>
                        <strong>–ò—Ç–æ–≥–æ (total_cost):</strong> {{ "%.2f"|format(s.total_cost) if s.total_cost is not none else '‚Äî' }} <br>
                        </div>

                        <div style="margin-top:10px;">
                        <button class="btn-update-shipment" data-id="{{ s.id }}">–û–±–Ω–æ–≤–∏—Ç—å</button>
                        <button class="btn-send-tracking" data-id="{{ s.id }}">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç—Ä–µ–∫</button>
                        </div>
                    </div>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr><td colspan="8" class="no-data">–ù–µ—Ç –ø–æ—Å—ã–ª–æ–∫</td></tr>
                {% endif %}
            </tbody>
            </table>
        </div>
        </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
    // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–û–ï ====================
    function escapeHtml(text) {
        if (!text) return '';
        return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // ==================== –¢–ê–ë–´ ====================
    function initTabs() {
        const tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(content => {
        if (content.id !== 'replenishments-tab') content.style.display = 'none';
        });

        document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            const tabId = this.dataset.tab + '-tab';
            const tabContent = document.getElementById(tabId);
            if (tabContent) tabContent.style.display = 'block';
        });
        });
    }

    // ==================== –ü–û–ü–û–õ–ù–ï–ù–ò–Ø ====================
    async function handleReplenishmentAction(action, replenishmentId) {
        try {
        const comment = action === 'approve' ? '–û–¥–æ–±—Ä–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º' : '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º';
        const endpoint = `/api/replenishments/${replenishmentId}/${action}`;
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `comment=${encodeURIComponent(comment)}`
        });
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.message || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }
        const row = document.querySelector(`tr[data-id="${replenishmentId}"]`);
        if (row) row.remove();
        alert(`–ó–∞—è–≤–∫–∞ ${action === 'approve' ? '–æ–¥–æ–±—Ä–µ–Ω–∞' : '–æ—Ç–∫–ª–æ–Ω–µ–Ω–∞'}`);
        } catch (error) {
        console.error('Error:', error);
        alert(`–û—à–∏–±–∫–∞: ${error.message}`);
        }
    }

    // === –°—Ç–∞—Ç—É—Å –ø–æ—Å—ã–ª–∫–∏: —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å ===
    async function setShipmentStatus(btn){
        const id   = btn.dataset.shipmentId;
        const url  = btn.dataset.url;
        const sel  = document.getElementById(`status-select-${id}`);
        const hint = document.getElementById(`status-hint-${id}`);
        const cell = document.getElementById(`status-summary-${id}`);

        if (!sel) return;
        const status = sel.value;

        btn.disabled = true;
        if (hint) hint.textContent = '–°–æ—Ö—Ä–∞–Ω—è–µ–º...';

        try {
            const r = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status })
            });
            const d = await r.json().catch(() => ({}));
            if (!r.ok || !d.success) {
            alert(d.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å');
            btn.disabled = false;
            if (hint) hint.textContent = '';
            return;
            }

            if (cell) cell.textContent = d.status_label || d.status || status; // –æ–±–Ω–æ–≤–∏–ª–∏ —Ç–µ–∫—Å—Ç

            if (hint) { // –Ω–µ–±–æ–ª—å—à–æ–π ¬´—É—Å–ø–µ—Ö¬ª
            hint.style.color = '#2e7d32';
            hint.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
            setTimeout(() => { hint.textContent = ''; }, 1500);
            }
        } catch (e) {
            console.error(e);
            alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞');
            if (hint) hint.textContent = '';
        } finally {
            btn.disabled = false;
        }
    }

    // –Ω–∞–≤–µ—à–∏–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    document.querySelectorAll('.btn-set-status').forEach(b => {
    b.addEventListener('click', () => setShipmentStatus(b));
    });


    // ==================== –í–´–í–û–î–´ ====================
    async function handleWithdrawalAction(action, withdrawalId) {
        try {
        const comment = prompt("–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:",
            action === 'approve' ? "–û–¥–æ–±—Ä–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º" : "–û—Ç–∫–ª–æ–Ω–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º");
        if (comment === null) return;

        const response = await fetch(`/admin/withdrawals/${withdrawalId}/${action}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
            comment: comment,
            admin_id: {{ user.id }}
            })
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.message || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }

        const row = document.querySelector(`#withdrawals-body tr[data-id="${withdrawalId}"]`);
        if (row) {
            const statusCell = row.querySelector('td:nth-child(7)');
            if (statusCell) {
            statusCell.className = `status-${action === 'approve' ? 'approved' : 'rejected'}`;
            statusCell.textContent = action === 'approve' ? '–û–¥–æ–±—Ä–µ–Ω–æ' : '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ';
            const actionsCell = row.querySelector('td:last-child');
            if (actionsCell) actionsCell.innerHTML = '';
            }
        }
        alert(`–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ ${action === 'approve' ? '–æ–¥–æ–±—Ä–µ–Ω–∞' : '–æ—Ç–∫–ª–æ–Ω–µ–Ω–∞'}`);
        } catch (error) {
        console.error('Error:', error);
        alert(`–û—à–∏–±–∫–∞: ${error.message}`);
        }
    }

    async function refreshWithdrawals() {
        try {
        const response = await fetch('/admin/withdrawals/data');
        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        const data = await response.json();
        const tbody = document.getElementById('withdrawals-body');
        if (!tbody) return;

        if (!data.length) {
            tbody.innerHTML = '<tr><td colspan="8" class="no-data">–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –∑–∞—è–≤–æ–∫</td></tr>';
            return;
        }

        tbody.innerHTML = data.map(w => `
            <tr data-id="${w.id}">
            <td>${w.id}</td>
            <td>${escapeHtml(w.user_name)}</td>
            <td>${Number(w.amount || 0).toFixed(2)} ‚ÇΩ</td>
            <td>${w.card_number || '‚Äî'}</td>
            <td>${escapeHtml(w.card_holder || '‚Äî')}</td>
            <td>${w.created_at ? w.created_at : ''}</td>
            <td class="status-${w.status}">
                ${w.status === 'pending' ? '–û–∂–∏–¥–∞–µ—Ç' : w.status === 'approved' ? '–û–¥–æ–±—Ä–µ–Ω–æ' : '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ'}
            </td>
            <td>
                ${w.status === 'pending' ? `
                <button class="action-btn btn-approve" data-id="${w.id}">–û–¥–æ–±—Ä–∏—Ç—å</button>
                <button class="action-btn btn-reject" data-id="${w.id}">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                ` : ''}
            </td>
            </tr>
        `).join('');
        } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
        const tbody = document.getElementById('withdrawals-body');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="8" class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        }
        }
    }

    // ==================== –ó–ê–ö–ê–ó–´: –î–ï–¢–ê–õ–ò/–°–¢–ê–¢–£–°/–í–ï–°/–§–û–¢–û ====================
    function setupOrderDetails() {
        document.querySelectorAll('.btn-details').forEach(btn => {
        btn.addEventListener('click', function() {
            const orderId = this.dataset.id;
            const detailsRow = document.querySelector(`.order-details-row[data-id="${orderId}"] .order-details`);
            if (!detailsRow) return;
            detailsRow.classList.toggle('active');
            const icon = this.querySelector('span');
            if (icon) {
            if (detailsRow.classList.contains('active')) {
                icon.textContent = 'üîΩ';
                this.setAttribute('title', '–°–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏');
            } else {
                icon.textContent = 'üîç';
                this.setAttribute('title', '–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏');
            }
            }
        });
        });
    }

    document.querySelectorAll('.order-summary').forEach(row => {
        row.addEventListener('click', () => {
        const id = row.dataset.id;
        const detailsRow = document.querySelector(`.order-details-row[data-id="${id}"]`);
        if (!detailsRow) return;
        detailsRow.style.display = detailsRow.style.display === 'table-row' ? 'none' : 'table-row';
        });
    });

    document.querySelectorAll('.btn-save-status').forEach(btn => {
        btn.addEventListener('click', async () => {
        const orderId = btn.dataset.orderId;
        const select = document.querySelector(`.status-select[data-order-id="${orderId}"]`);
        const newStatus = select ? select.value : null;
        try {
            const resp = await fetch(`/api/orders/${orderId}/status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
            });
            if (!resp.ok) throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É');
            alert('–°—Ç–∞—Ç—É—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω');
        } catch (err) {
            console.error(err);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å: ' + err.message);
        }
        });
    });

    document.querySelectorAll('.btn-save-cn-price').forEach(btn => {
        btn.addEventListener('click', async () => {
        const orderId = btn.dataset.orderId;
        const input = document.querySelector(`.cn-delivery-price-input[data-order-id="${orderId}"]`);
        const raw = input ? input.value.trim() : '';
        const price = raw === '' ? null : parseFloat(raw);
        try {
            const resp = await fetch(`/api/orders/${orderId}/cn_delivery_price`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cn_delivery_price: price })
            });
            const data = await resp.json().catch(() => ({}));
            if (!resp.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            alert('–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
        } catch (err) {
            console.error(err);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É: ' + err.message);
        }
        });
    });

    document.querySelectorAll('.btn-save-weight').forEach(btn => {
        btn.addEventListener('click', async () => {
        const orderId = btn.dataset.orderId;
        const input = document.querySelector(`.weight-input[data-order-id="${orderId}"]`);
        const raw = input ? input.value.trim() : '';
        const weight = raw === '' ? null : parseFloat(raw);
        try {
            const resp = await fetch(`/api/orders/${orderId}/weight`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ weight: weight })
            });
            const data = await resp.json().catch(() => ({}));
            if (!resp.ok) throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            alert('–í–µ—Å —Ç–æ–≤–∞—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
        } catch (err) {
            console.error(err);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–µ—Å: ' + err.message);
        }
        });
    });

    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('btn-add-photo')) {
        const orderId = e.target.dataset.orderId;
        const input = e.target.previousElementSibling;
        const photoUrl = (input && input.value || '').trim();

        if (!photoUrl) { alert('–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–æ—Ç–æ'); return; }
        if (!/\.(jpeg|jpg|png|gif|webp)$/i.test(photoUrl)) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (JPEG, PNG, GIF, WebP)');
            return;
        }

        fetch(`/admin/orders/${orderId}/add_photo`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ photo_url: photoUrl })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
            input.value = '';
            const photoList = document.querySelector(`.photo-list[data-order-id="${orderId}"]`);
            const photoItem = document.createElement('div');
            photoItem.className = 'photo-item';
            photoItem.dataset.url = photoUrl;
            photoItem.innerHTML = `
                <img src="${photoUrl}" alt="–§–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞" style="max-width:150px;max-height:150px;margin:5px;border:1px solid #ddd;">
                <button class="btn-remove-photo" data-url="${photoUrl}" data-order-id="${orderId}"
                style="background:#ff4d4d;color:#fff;border:none;border-radius:50%;width:25px;height:25px;cursor:pointer;">√ó</button>`;
            if (photoList) photoList.appendChild(photoItem);
            } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(err => {
            console.error(err);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ');
        });
        }
    });

    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('btn-remove-photo')) {
        const photoUrl = e.target.dataset.url;
        const orderId = e.target.dataset.orderId;
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Ñ–æ—Ç–æ?')) return;

        fetch(`/admin/orders/${orderId}/remove_photo`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ photo_url: photoUrl })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
            const item = e.target.closest('.photo-item');
            if (item) item.remove();
            } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ');
            }
        })
        .catch(err => {
            console.error(err);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–æ—Ç–æ');
        });
        }
    });

    // ==================== –ü–û–°–´–õ–ö–ò: –î–ï–¢–ê–õ–ò –ò –£–ü–ê–ö–û–í–ö–ê ====================
    // –ü–æ–¥–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.btn-show-shipment-details');
        if (!btn) return;
        const id = btn.dataset.id;
        const detailsRow = document.querySelector(`.shipment-details-row[data-id="${id}"]`);
        if (!detailsRow) return;

        const isShown = detailsRow.style.display === 'table-row' || detailsRow.style.display === 'block';
        detailsRow.style.display = isShown ? 'none' : 'table-row';

        if (!isShown) {
        const missingItems = detailsRow.querySelector('ul li') &&
                            detailsRow.querySelector('ul li').textContent.includes('–î–µ—Ç–∞–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
        if (missingItems) {
            fetch(`/admin/shipments/${id}/details`)
            .then(r => r.ok ? r.json() : Promise.reject(r))
            .then(data => {
                if (data && data.items) {
                const ul = detailsRow.querySelector('ul');
                if (ul) {
                    ul.innerHTML = '';
                    data.items.forEach(it => {
                    const li = document.createElement('li');
                    let txt = '';
                    if (it.product_title) txt += `<strong>${escapeHtml(it.product_title)}</strong> ‚Äî `;
                    if (it.our_tracking_number) txt += `our: ${escapeHtml(it.our_tracking_number)} `;
                    if (it.china_tracking_number) txt += `cn: ${escapeHtml(it.china_tracking_number)} `;
                    if (it.order_id) txt += `(order #${it.order_id})`;
                    li.innerHTML = txt;
                    ul.appendChild(li);
                    });
                }
                }
            })
            .catch(err => console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –ø–æ—Å—ã–ª–∫–∏', err));
        }
        }
    });

    // –í—ã—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å —É–ø–∞–∫–æ–≤–∫–∏ (–∞–¥–º–∏–Ω)
    async function setPackagingAmount(btn) {
        const shipmentId = btn.dataset.shipmentId;
        const url        = btn.dataset.url;
        const input      = document.querySelector(`.packaging-input[data-shipment-id="${shipmentId}"]`);
        const badgeSpan  = document.getElementById(`pkg-badge-${shipmentId}`);
        const hintEl     = document.getElementById(`status-hint-${shipmentId}`); // –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π —Ö–∏–Ω—Ç —Å–ø—Ä–∞–≤–∞ –æ—Ç –∫–Ω–æ–ø–æ–∫
        const summaryTd  = document.getElementById(`pkg-summary-${shipmentId}`);
        const amountDet  = document.getElementById(`pkg-amount-${shipmentId}`);

        if (!input) return;
        const raw = (input.value || '').trim();
        const val = raw === '' ? NaN : parseFloat(raw);

        if (Number.isNaN(val) || val < 0) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É –≤ —é–∞–Ω—è—Ö (0.00 –∏–ª–∏ –±–æ–ª—å—à–µ).');
            return;
        }

        btn.disabled = true;
        if (hintEl) { hintEl.style.color = '#6b7280'; hintEl.textContent = '–°–æ—Ö—Ä–∞–Ω—è–µ–º...'; }

        try {
            const resp = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount_cny: val })
            });
            const data = await resp.json().catch(() => ({}));
            if (!resp.ok || !data.success) {
            alert(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å —É–ø–∞–∫–æ–≤–∫–∏');
            if (hintEl) hintEl.textContent = '';
            btn.disabled = false;
            return;
            }

            // –õ–û–ö–ê–õ–¨–ù–û –æ–±–Ω–æ–≤–ª—è–µ–º UI (–ù–ï —É–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É, –ù–ï –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º)
            const costStr = val.toFixed(2);

            // 1) –∫—Ä–∞—Ç–∫–∞—è —è—á–µ–π–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ
            if (summaryTd) {
            summaryTd.innerHTML = `
                <span class="pkg-amount" data-amount="${costStr}">${costStr} CNY</span>
                <span class="badge-unpaid">–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</span>
            `;
            }

            // 2) –±–µ–π–¥–∂ –≤ –±–ª–æ–∫–µ –¥–µ—Ç–∞–ª–µ–π
            if (badgeSpan) {
            badgeSpan.innerHTML = `<span class="badge-unpaid">–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</span>`;
            }

            // 3) –∏–Ω–ø—É—Ç –∏ –∫–Ω–æ–ø–∫–∞ –≤ –±–ª–æ–∫–µ –¥–µ—Ç–∞–ª–µ–π
            input.value    = costStr;
            btn.disabled   = false; // –∫–Ω–æ–ø–∫—É –æ—Å—Ç–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ–π –Ω–∞ —Å–ª—É—á–∞–π –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—É–º–º—ã

            // 4) —Å—Ç—Ä–æ–∫–∞ ¬´–°—Ç–æ–∏–º–æ—Å—Ç—å —É–ø–∞–∫–æ–≤–∫–∏: ‚Ä¶¬ª –≤ –¥–µ—Ç–∞–ª—è—Ö
            if (amountDet) amountDet.textContent = costStr;

            // 5) –Ω–µ–±–æ–ª—å—à–æ–π ¬´—É—Å–ø–µ—Ö¬ª —Ö–∏–Ω—Ç
            if (hintEl) {
            hintEl.style.color = '#2e7d32';
            hintEl.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
            setTimeout(() => { hintEl.textContent = ''; }, 1200);
            }
        } catch (e) {
            console.error(e);
            alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞');
        } finally {
            btn.disabled = false;
        }
    }
    // –ü—Ä–∏–≤—è–∑–∫–∞ –∫–Ω–æ–ø–∫–∏ "–í—ã—Å—Ç–∞–≤–∏—Ç—å —Å—á—ë—Ç"
    document.querySelectorAll('.btn-set-packaging').forEach(btn => {
        btn.addEventListener('click', () => setPackagingAmount(btn));
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI —É–ø–∞–∫–æ–≤–∫–∏ –≤ —Å–ø–∏—Å–∫–µ –∏ –¥–µ—Ç–∞–ª—è—Ö
    function renderPackagingUI(id, cost, paid) {
        cost = Number(cost || 0);
        paid = !!paid;

        const summaryTd = document.getElementById(`pkg-summary-${id}`);
        const badgeSpan = document.getElementById(`pkg-badge-${id}`);
        const input     = document.getElementById(`pkg-input-${id}`);
        const btnSet    = document.getElementById(`btn-set-packaging-${id}`);
        const amountInDetails = document.getElementById(`pkg-amount-${id}`);

        if (summaryTd) {
        if (cost > 0) {
            summaryTd.innerHTML = `
            <span class="pkg-amount" data-amount="${cost.toFixed(2)}">${cost.toFixed(2)} CNY</span>
            ${paid ? '<span class="badge-paid">–û–ø–ª–∞—á–µ–Ω–æ</span>' : '<span class="badge-unpaid">–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</span>'}
            `;
        } else {
            summaryTd.textContent = '‚Äî';
        }
        }
        if (badgeSpan) {
        if (cost > 0) {
            badgeSpan.innerHTML = paid ? '<span class="badge-paid">–û–ø–ª–∞—á–µ–Ω–æ</span>' : '<span class="badge-unpaid">–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</span>';
        } else {
            badgeSpan.innerHTML = '';
        }
        }
        if (input) {
        input.value = cost > 0 ? cost.toFixed(2) : '';
        input.disabled = paid;
        }
        if (btnSet) {
        btnSet.disabled = paid;
        if (paid) btnSet.style.display = 'none';
        }
        if (amountInDetails) {
        amountInDetails.textContent = cost > 0 ? cost.toFixed(2) : '‚Äî';
        }
    }

    // –ü—É–ª–ª–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å–∞ —É–ø–∞–∫–æ–≤–∫–∏ (—á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å "–û–ø–ª–∞—á–µ–Ω–æ" –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º)
    const makeStatusUrl = (id) => `/admin/shipments/${id}/details`;

    async function refreshPackagingFor(id) {
        try {
        const resp = await fetch(makeStatusUrl(id), { method: 'GET' });
        if (!resp.ok) return;
        const data = await resp.json().catch(() => ({}));
        let cost = parseFloat((data && data.packaging_cost) || 0);
        let paid = parseInt((data && data.packaging_paid) || 0, 10);
        if (Number.isNaN(cost)) cost = 0;
        if (Number.isNaN(paid)) paid = 0;
        renderPackagingUI(id, cost, !!paid);
        } catch (_) { /* –º–æ–ª—á–∞ */ }
    }

    async function refreshAllPackaging() {
        const rows = document.querySelectorAll('tr.shipment-summary[data-id]');
        for (const row of rows) {
        const id = row.getAttribute('data-id');
        await refreshPackagingFor(id);
        }
    }

    // –ö–Ω–æ–ø–∫–∞ —Ä—É—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å –≤ —Ä–∞–∑–º–µ—Ç–∫–µ)
    const btnRefresh = document.getElementById('btn-refresh-packaging');
    if (btnRefresh) btnRefresh.addEventListener('click', refreshAllPackaging);

    // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –î–ï–õ–ï–ì–ê–¢–û–†–´ ====================
    function setupEventListeners() {
        document.addEventListener('click', function(e) {
        const approveBtn = e.target.closest('.btn-approve');
        const rejectBtn  = e.target.closest('.btn-reject');
        if (approveBtn || rejectBtn) {
            const btn = approveBtn || rejectBtn;
            const action = approveBtn ? 'approve' : 'reject';
            const tab = btn.closest('.tab-content')?.id;
            if (tab === 'replenishments-tab') {
            handleReplenishmentAction(action, btn.dataset.id);
            } else if (tab === 'withdrawals-tab') {
            handleWithdrawalAction(action, btn.dataset.id);
            }
        }
        });
    }

    // ==================== –ò–ù–ò–¶ ====================
    initTabs();
    setupEventListeners();
    setupOrderDetails();

    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    refreshWithdrawals();
    const refreshInterval = setInterval(refreshWithdrawals, 30000);

    refreshAllPackaging();
    const packagingInterval = setInterval(refreshAllPackaging, 15000);

    window.addEventListener('beforeunload', () => {
        clearInterval(refreshInterval);
        clearInterval(packagingInterval);
    });
    });
</script>
</body>
</html>
