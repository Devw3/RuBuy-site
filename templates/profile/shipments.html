<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мои посылки</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #010103;
            --card-bg: #232325;
            --header-bg: #232325;
            --text-light: #dcdcde;
            --text-dark: #7b7a7a;
            --accent-red: #e53935;
            --border-color: #3a3a3c;
            --accent-blue: #4361ee;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-light);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; margin: 20px 0 30px; color: var(--text-light); font-size: 2rem; }
        .orders-list { display: grid; grid-template-columns: 1fr; row-gap: 30px; }
        .order { background: var(--card-bg); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .order-header { background: var(--header-bg); color: var(--text-light); padding: 15px 20px; font-weight: 600; display:flex; justify-content:space-between; align-items:center; }
        .order-items { padding: 0 10px; }
        .order-item { display:flex; align-items:flex-start; padding:20px 0; border-bottom:1px solid var(--border-color); gap:15px; }
        .order-item:last-child { border-bottom:none; }
        .item-image { width:80px; height:80px; object-fit:cover; border-radius:6px; flex-shrink:0; }
        .item-details { flex:1; }
        .item-status { padding:5px 12px; border-radius:20px; font-size:0.85rem; font-weight:600; background:rgba(229,57,53,0.1); color:var(--accent-red); align-self:center; margin-left:auto; white-space:nowrap; }
        .no-orders { text-align:center; padding:50px 20px; background:var(--card-bg); border-radius:12px; font-size:1.1rem; }

        /* Photos */
        .shipment-photos { display:flex; gap:8px; margin-right:15px; }
        .photo-container { position:relative; width:80px; height:80px; }
        .shipment-photo { width:100%; height:100%; object-fit:cover; border-radius:6px; border:1px solid var(--border-color); cursor:pointer; transition:all 0.3s ease; display:block; }
        .shipment-photo:hover { transform:scale(1.05); box-shadow:0 4px 10px rgba(67,97,238,0.3); }
        .extra-count { position:absolute; bottom:5px; right:5px; background:rgba(0,0,0,0.6); color:white; font-size:0.7rem; padding:2px 5px; border-radius:10px; }
        .no-photo { width:80px; height:80px; display:flex; align-items:center; justify-content:center; background:#1a1a1a; border-radius:6px; color:var(--text-dark); font-size:0.8rem; text-align:center; }

        /* Modal single */
        .modal { display:none; position:fixed; z-index:999999; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.95); overflow:hidden; }
        #modalPhoto { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); max-width:95%; max-height:95%; object-fit:contain; display:block; }
        .close { position:absolute; top:25px; right:35px; color:white; font-size:40px; font-weight:bold; cursor:pointer; z-index:1000000; transition:all 0.3s; background:rgba(0,0,0,0.4); width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center; }
        .close:hover { color:var(--accent-red); transform:scale(1.05); }
        .modal-nav { position:absolute; top:50%; transform:translateY(-50%); width:100%; display:flex; justify-content:space-between; padding:0 20px; z-index:100000; pointer-events:none; }
        .modal-nav button { pointer-events:auto; }
        .nav-btn { background:rgba(0,0,0,0.5); color:white; border:none; width:50px; height:50px; border-radius:50%; font-size:24px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.3s; }
        .nav-btn:hover { background:rgba(67,97,238,0.7); transform:scale(1.05); }
        .image-counter { position:absolute; bottom:20px; left:50%; transform:translateX(-50%); color:white; background:rgba(0,0,0,0.5); padding:5px 15px; border-radius:20px; font-size:0.9rem; z-index:100000; }

        /* Grid modal */
        .modal-grid { display:none; position:fixed; z-index:999998; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.95); overflow:auto; padding:20px; box-sizing:border-box; }
        .modal-grid-content { max-width:1400px; margin:40px auto; }
        .modal-grid-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; color:white; padding:0 10px; }
        .photos-grid-container { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:15px; }
        .grid-photo-item { position:relative; width:100%; height:180px; border-radius:8px; overflow:hidden; cursor:pointer; transition:all 0.3s ease; background-color:#1a1a1a; display:flex; align-items:center; justify-content:center; }
        .grid-photo-item img { width:100%; height:100%; object-fit:cover; transition:transform 0.3s ease; display:block; }
        .grid-photo-item:hover img { transform:scale(1.05); }
        .photo-counter { position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.7); color:white; font-size:0.8rem; padding:3px 8px; border-radius:10px; }
        .close-grid { color:white; font-size:28px; font-weight:bold; cursor:pointer; transition:all 0.3s; background:rgba(0,0,0,0.5); width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center; }
        .photo-count-info { font-size:1.2rem; font-weight:500; }

        .view-all-photos { padding:15px 0; text-align:center; }
        .view-all-btn { background:var(--accent-blue); color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-size:1rem; transition:all 0.3s; display:inline-flex; align-items:center; gap:8px; }
        .view-all-btn:hover { background:rgba(67,97,238,0.8); transform:translateY(-2px); }

        @media (max-width:480px) {
            .order-item { gap:7px; }
            .item-image { width:100px; height:100px; }
            .grid-photo-item { height:120px; }
        }
    </style>
</head>
<body>
    <a href="{{ url_for('profile') }}" class="back-button" style="color:var(--accent-blue); text-decoration:none; display:inline-block; margin-bottom:20px;">
        <i class="fas fa-arrow-left"></i> Назад к балансу
    </a>

    <div class="container">
        <h1>Мои посылки</h1>

        {% if shipments %}
            <div class="orders-list">
                {% for shipment in shipments %}
                    <div class="order">
                        <div class="order-header">
                            <span>Посылка №{{ shipment.id }}</span>
                            <span>{{ shipment.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
                        </div>
                        
                        <div class="order-items">
                            <div class="order-item">
                                <div class="shipment-photos">
                                    {% for photo_url in shipment.photo_urls[:3] %}
                                        <div class="photo-container">
                                            <!-- Передаём весь массив photo_urls в data-photos и индекс конкретного показа -->
                                            <img src="{{ photo_url }}" 
                                                 alt="Фото товара" 
                                                 class="shipment-photo"
                                                 data-photos='{{ shipment.photo_urls|tojson|safe }}'
                                                 data-index="{{ loop.index0 }}">
                                            {% if loop.last and loop.index == 3 and shipment.photo_urls|length > 3 %}
                                                <div class="extra-count">+{{ shipment.photo_urls|length - 3 }}</div>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                    {% if shipment.photo_urls|length == 0 %}
                                        <div class="no-photo">Нет фото</div>
                                    {% endif %}
                                </div>
                                
                                <div class="item-details">
                                    <div class="shipment-details">
                                        <div class="detail-row">
                                            <span class="detail-label">Город отправления:</span>
                                            <span class="detail-value">{{ shipment.recipient_city }}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label">Адрес отправления:</span>
                                            <span class="detail-value">{{ shipment.recipient_address }}</span>
                                        </div>
                                        
                                        <div class="detail-row">
                                            <span class="detail-label">Товаров:</span>
                                            <span class="detail-value">{{ shipment.photo_urls|length }} шт.</span>
                                        </div>
                                        
                                        <div class="detail-row">
                                            <span class="detail-label">Общий вес:</span>
                                            <span class="detail-value">{{ shipment.total_weight }} кг</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="item-status status-{{ shipment.status }}">
                                    {% if shipment.status == 'pending' %}Ожидает обработки{% endif %}
                                    {% if shipment.status == 'processing' %}В обработке{% endif %}
                                    {% if shipment.status == 'shipped' %}Отправлена{% endif %}
                                    {% if shipment.status == 'delivered' %}Доставлена{% endif %}
                                </div>
                            </div>
                            
                            <!-- Кнопка для открытия всех фото -->
                            {% if shipment.photo_urls|length > 0 %}
                                <div class="view-all-photos">
                                    <button class="view-all-btn" 
                                            data-photos='{{ shipment.photo_urls|tojson|safe }}'>
                                        <i class="fas fa-images"></i> Просмотреть все фото ({{ shipment.photo_urls|length }})
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-orders">
                <p>У вас пока нет посылок.</p>
            </div>
        {% endif %}
    </div>

    <!-- Модальное окно для фото (старое) -->
    <div id="photoModal" class="modal" aria-hidden="true">
        <span class="close" id="modalClose" title="Закрыть">&times;</span>
        <div class="modal-nav">
            <button class="nav-btn prev-btn" id="prevBtn" title="Предыдущее">❮</button>
            <button class="nav-btn next-btn" id="nextBtn" title="Следующее">❯</button>
        </div>
        <img id="modalPhoto" alt="Просмотр фото">
        <div class="image-counter" id="imageCounter"></div>
    </div>
    
    <!-- Новое модальное окно с сеткой фотографий -->
    <div id="photoGridModal" class="modal-grid" aria-hidden="true">
        <div class="modal-grid-content">
            <div class="modal-grid-header">
                <div class="photo-count-info">Фотографии: <span id="photoCount">0</span></div>
                <span class="close-grid" id="gridClose" title="Закрыть">×</span>
            </div>
            
            <!-- <div class="photo-filters">
                <button class="filter-btn active" data-filter="all">Все</button>
                <button class="filter-btn" data-filter="originals">Оригиналы</button>
                <button class="filter-btn" data-filter="checked">Проверка</button>
            </div>
             -->
            <div class="photos-grid-container" id="photosGrid">
                <!-- Фотографии будут вставлены сюда динамически -->
            </div>
        </div>
    </div>
    
    <script>
        // Глобальные переменные
        let currentPhotoIndex = 0;
        let currentPhotos = [];

        // Открыть одиночный модал с фотографией
        function openPhotoModal(photos, index) {
            if (!Array.isArray(photos)) {
                // Если пришла строка - пробуем распарсить
                try {
                    photos = JSON.parse(photos);
                } catch (err) {
                    console.error('Invalid photos data:', photos);
                    photos = [];
                }
            }

            if (!Array.isArray(photos) || photos.length === 0) {
                console.warn('Нет фотографий для отображения');
                return;
            }

            // Защита от выхода за границы
            index = Number(index) || 0;
            index = Math.max(0, Math.min(index, photos.length - 1));

            const modal = document.getElementById('photoModal');
            const modalImg = document.getElementById('modalPhoto');
            const counter = document.getElementById('imageCounter');

            currentPhotos = photos;
            currentPhotoIndex = index;

            modalImg.src = currentPhotos[currentPhotoIndex];
            counter.textContent = `${currentPhotoIndex + 1} / ${currentPhotos.length}`;

            modal.style.display = 'block';
            modal.setAttribute('aria-hidden', 'false');

            // блокируем скролл страницы
            document.body.style.overflow = 'hidden';
        }

        // Навигация по фото
        function navigatePhoto(direction) {
            if (!Array.isArray(currentPhotos) || currentPhotos.length === 0) return;

            currentPhotoIndex += direction;

            if (currentPhotoIndex < 0) currentPhotoIndex = currentPhotos.length - 1;
            if (currentPhotoIndex >= currentPhotos.length) currentPhotoIndex = 0;

            const modalImg = document.getElementById('modalPhoto');
            const counter = document.getElementById('imageCounter');

            // Плавный переход: скрываем, меняем src, показываем
            modalImg.style.opacity = 0;
            setTimeout(() => {
                modalImg.src = currentPhotos[currentPhotoIndex];
                counter.textContent = `${currentPhotoIndex + 1} / ${currentPhotos.length}`;
                modalImg.style.opacity = 1;
            }, 80);
        }

        // Закрыть одиночный модал
        function closePhotoModal() {
            const modal = document.getElementById('photoModal');
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
            currentPhotos = [];
            currentPhotoIndex = 0;
            document.getElementById('modalPhoto').src = '';
            document.body.style.overflow = 'auto';
        }

        // Открыть сетку фото (grid modal)
        function openPhotoGrid(photos) {
            if (!Array.isArray(photos)) {
                try {
                    photos = JSON.parse(photos);
                } catch (err) {
                    console.error('Invalid photos data for grid:', photos);
                    photos = [];
                }
            }

            const modal = document.getElementById('photoGridModal');
            const gridContainer = document.getElementById('photosGrid');
            const photoCount = document.getElementById('photoCount');

            gridContainer.innerHTML = '';

            if (!Array.isArray(photos) || photos.length === 0) {
                gridContainer.innerHTML = '<div style="color:#ddd">Нет фотографий</div>';
                photoCount.textContent = '0';
            } else {
                photos.forEach((photo, index) => {
                    const photoItem = document.createElement('div');
                    photoItem.className = 'grid-photo-item';
                    photoItem.innerHTML = `
                        <img loading="lazy" src="${photo}" alt="Фото товара ${index + 1}">
                        <div class="photo-counter">${index + 1}</div>
                    `;
                    photoItem.addEventListener('click', () => {
                        openPhotoModal(photos, index);
                    });
                    gridContainer.appendChild(photoItem);
                });
                photoCount.textContent = photos.length;
            }

            modal.style.display = 'block';
            modal.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
        }

        function closePhotoGrid() {
            const modal = document.getElementById('photoGridModal');
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
            document.getElementById('photosGrid').innerHTML = '';
            document.body.style.overflow = 'auto';
        }

        // Привязка обработчиков после загрузки DOM
        document.addEventListener('DOMContentLoaded', () => {
            // Клик по миниатюре: используем data-attributes
            document.querySelectorAll('.shipment-photo').forEach(img => {
                img.addEventListener('click', (e) => {
                    const photosData = img.getAttribute('data-photos');
                    const index = img.getAttribute('data-index') || 0;
                    openPhotoModal(photosData, index);
                });
            });

            // Кнопки "Просмотреть все фото"
            document.querySelectorAll('.view-all-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const photosData = btn.getAttribute('data-photos');
                    openPhotoGrid(photosData);
                });
            });

            // Закрытие модалей
            document.getElementById('modalClose').addEventListener('click', closePhotoModal);
            document.getElementById('gridClose').addEventListener('click', closePhotoGrid);

            // Навигационные кнопки в модале
            document.getElementById('prevBtn').addEventListener('click', () => navigatePhoto(-1));
            document.getElementById('nextBtn').addEventListener('click', () => navigatePhoto(1));
        });

        // Закрытие кликом по фону
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('photoModal');
            const gridModal = document.getElementById('photoGridModal');

            if (event.target === modal) closePhotoModal();
            if (event.target === gridModal) closePhotoGrid();
        });

        // Клавиши
        document.addEventListener('keydown', (e) => {
            const modal = document.getElementById('photoModal');
            const gridModal = document.getElementById('photoGridModal');

            if (e.key === 'Escape') {
                if (modal.style.display === 'block') closePhotoModal();
                if (gridModal.style.display === 'block') closePhotoGrid();
            } else if (modal.style.display === 'block') {
                if (e.key === 'ArrowLeft') { navigatePhoto(-1); e.preventDefault(); }
                if (e.key === 'ArrowRight') { navigatePhoto(1); e.preventDefault(); }
            }
        });

        // Фильтрация кнопки (заглушка)
        document.addEventListener('click', (e) => {
            if (e.target.classList && e.target.classList.contains('filter-btn')) {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                // Реальную фильтрацию можно добавить здесь
                console.log('Применен фильтр:', e.target.dataset.filter);
            }
        });
    </script>
</body>
</html>
