<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мои посылки</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #010103;
            --card-bg: #232325;
            --header-bg: #232325;
            --text-light: #dcdcde;
            --text-dark: #7b7a7a;
            --accent-red: #e53935;
            --border-color: #3a3a3c;
            --accent-blue: #4361ee;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-light);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; margin: 20px 0 30px; color: var(--text-light); font-size: 2rem; }
        .orders-list { display: grid; grid-template-columns: 1fr; row-gap: 30px; }
        .order { background: var(--card-bg); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .order-header { background: var(--header-bg); color: var(--text-light); padding: 15px 20px; font-weight: 600; display:flex; justify-content:space-between; align-items:center; }
        .order-items { padding: 0 10px; }
        .order-item { display:flex; align-items:flex-start; padding:20px 0; border-bottom:1px solid var(--border-color); gap:15px; }
        .order-item:last-child { border-bottom:none; }
        .item-image { width:80px; height:80px; object-fit:cover; border-radius:6px; flex-shrink:0; }
        .item-details { flex:1; }
        .item-status { padding:5px 12px; border-radius:20px; font-size:0.85rem; font-weight:600; background:rgba(229,57,53,0.1); color:var(--accent-red); align-self:center; margin-left:auto; white-space:nowrap; }
        .no-orders { text-align:center; padding:50px 20px; background:var(--card-bg); border-radius:12px; font-size:1.1rem; }

        /* Photos */
        .shipment-photos { display:flex; gap:8px; margin-right:15px; }
        .photo-container { position:relative; width:80px; height:80px; }
        .shipment-photo { width:100%; height:100%; object-fit:cover; border-radius:6px; border:1px solid var(--border-color); cursor:pointer; transition:all 0.3s ease; display:block; }
        .shipment-photo:hover { transform:scale(1.05); box-shadow:0 4px 10px rgba(67,97,238,0.3); }
        .extra-count { position:absolute; bottom:5px; right:5px; background:rgba(0,0,0,0.6); color:white; font-size:0.7rem; padding:2px 5px; border-radius:10px; }
        .no-photo { width:80px; height:80px; display:flex; align-items:center; justify-content:center; background:#1a1a1a; border-radius:6px; color:var(--text-dark); font-size:0.8rem; text-align:center; }

        /* Modal single */
        .modal { display:none; position:fixed; z-index:999999; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.95); overflow:hidden; }
        #modalPhoto { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); max-width:95%; max-height:95%; object-fit:contain; display:block; }
        .close { position:absolute; top:25px; right:35px; color:white; font-size:40px; font-weight:bold; cursor:pointer; z-index:1000000; transition:all 0.3s; background:rgba(0,0,0,0.4); width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center; }
        .close:hover { color:var(--accent-red); transform:scale(1.05); }
        .modal-nav { position:absolute; top:50%; transform:translateY(-50%); width:100%; display:flex; justify-content:space-between; padding:0 20px; z-index:100000; pointer-events:none; }
        .modal-nav button { pointer-events:auto; }
        .nav-btn { background:rgba(0,0,0,0.5); color:white; border:none; width:50px; height:50px; border-radius:50%; font-size:24px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.3s; }
        .nav-btn:hover { background:rgba(67,97,238,0.7); transform:scale(1.05); }
        .image-counter { position:absolute; bottom:20px; left:50%; transform:translateX(-50%); color:white; background:rgba(0,0,0,0.5); padding:5px 15px; border-radius:20px; font-size:0.9rem; z-index:100000; }

        /* Grid modal */
        .modal-grid { display:none; position:fixed; z-index:999998; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.95); overflow:auto; padding:20px; box-sizing:border-box; }
        .modal-grid-content { max-width:1400px; margin:40px auto; }
        .modal-grid-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; color:white; padding:0 10px; }
        .photos-grid-container { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:15px; }
        .grid-photo-item { position:relative; width:100%; height:180px; border-radius:8px; overflow:hidden; cursor:pointer; transition:all 0.3s ease; background-color:#1a1a1a; display:flex; align-items:center; justify-content:center; }
        .grid-photo-item img { width:100%; height:100%; object-fit:cover; transition:transform 0.3s ease; display:block; }
        .grid-photo-item:hover img { transform:scale(1.05); }
        .photo-counter { position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.7); color:white; font-size:0.8rem; padding:3px 8px; border-radius:10px; }
        .close-grid { color:white; font-size:28px; font-weight:bold; cursor:pointer; transition:all 0.3s; background:rgba(0,0,0,0.5); width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center; }
        .photo-count-info { font-size:1.2rem; font-weight:500; }

        .view-all-photos { padding:15px 0; text-align:center; }
        .view-all-btn { background:var(--accent-blue); color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-size:1rem; transition:all 0.3s; display:inline-flex; align-items:center; gap:8px; }
        .view-all-btn:hover { background:rgba(67,97,238,0.8); transform:translateY(-2px); }

        @media (max-width:480px) {
            .order-item { gap:7px; }
            .item-image { width:100px; height:100px; }
            .grid-photo-item { height:120px; }
        }
    </style>
</head>
<body>
    <a href="{{ url_for('profile') }}" class="back-button" style="color:var(--accent-blue); text-decoration:none; display:inline-block; margin-bottom:20px;">
        <i class="fas fa-arrow-left"></i> Назад к балансу
    </a>

    <div class="container">
        <h1>Мои посылки</h1>

        {% if shipments %}
            <div class="orders-list">
                {% for shipment in shipments %}
                    <div class="order">
                        <div class="order-header">
                            <span>Посылка №{{ shipment.id }}</span>
                            <span>{{ shipment.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
                        </div>
                        
                        <div class="order-items">
                            <div class="order-item">
                                <div class="shipment-photos">
                                    {% for photo_url in shipment.photo_urls[:3] %}
                                        <div class="photo-container">
                                            <!-- Передаём весь массив photo_urls в data-photos и индекс конкретного показа -->
                                            <img src="{{ photo_url }}" 
                                                 alt="Фото товара" 
                                                 class="shipment-photo"
                                                 data-photos='{{ shipment.photo_urls|tojson|safe }}'
                                                 data-index="{{ loop.index0 }}">
                                            {% if loop.last and loop.index == 3 and shipment.photo_urls|length > 3 %}
                                                <div class="extra-count">+{{ shipment.photo_urls|length - 3 }}</div>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                    {% if shipment.photo_urls|length == 0 %}
                                        <div class="no-photo">Нет фото</div>
                                    {% endif %}
                                </div>
                                
                                <div class="item-details">
                                    <div class="shipment-details">
                                        <div class="detail-row">
                                            <span class="detail-label">Город отправления:</span>
                                            <span class="detail-value">{{ shipment.recipient_city }}</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label">Адрес отправления:</span>
                                            <span class="detail-value">{{ shipment.recipient_address }}</span>
                                        </div>
                                        
                                        <div class="detail-row">
                                            <span class="detail-label">Товаров:</span>
                                            <span class="detail-value">{{ shipment.photo_urls|length }} шт.</span>
                                        </div>
                                        
                                        <div class="detail-row">
                                            <span class="detail-label">Общий вес:</span>
                                            <span class="detail-value">{{ shipment.total_weight }} кг</span>
                                        </div>

                                        {% set pkg_cost = (shipment.get('packaging_cost', 0) | float) %}
                                        {% set pkg_paid = (shipment.get('packaging_paid', 0) | int) %}

                                        <div class="detail-row">
                                          <span class="detail-label">Упаковка:</span>
                                          <span class="detail-value">
                                            {% if pkg_cost > 0 %}
                                              {{ "%.2f"|format(pkg_cost) }} CNY
                                              {% if pkg_paid %}
                                                <span style="margin-left:8px;color:#2e7d32;background:#e6f4ea;padding:3px 8px;border-radius:6px;font-weight:600;font-size:12px;">
                                                  Оплачено
                                                </span>
                                              {% else %}
                                                <button
                                                  class="btn-pay-packaging"
                                                  data-shipment-id="{{ shipment.id }}"
                                                  data-amount="{{ "%.2f"|format(pkg_cost) }}"
                                                  style="margin-left:10px;padding:8px 12px;border:none;border-radius:8px;background:#2563eb;color:#fff;font-weight:600;cursor:pointer;"
                                                >
                                                  Оплатить упаковку
                                                </button>
                                              {% endif %}
                                            {% else %}
                                              Не выставлена
                                            {% endif %}
                                          </span>
                                        </div>

                                    </div>
                                </div>
                                
                                <div class="item-status status-{{ shipment.status }}">
                                    {% if shipment.status == 'pending' %}Ожидает обработки{% endif %}
                                    {% if shipment.status == 'processing' %}В обработке{% endif %}
                                    {% if shipment.status == 'shipped' %}Отправлена{% endif %}
                                    {% if shipment.status == 'delivered' %}Доставлена{% endif %}
                                </div>
                            </div>
                            
                            <!-- Кнопка для открытия всех фото -->
                            {% if shipment.photo_urls|length > 0 %}
                                <div class="view-all-photos">
                                    <button class="view-all-btn" 
                                            data-photos='{{ shipment.photo_urls|tojson|safe }}'>
                                        <i class="fas fa-images"></i> Просмотреть все фото ({{ shipment.photo_urls|length }})
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-orders">
                <p>У вас пока нет посылок.</p>
            </div>
        {% endif %}
    </div>

    <!-- Модальное окно для фото (старое) -->
    <div id="photoModal" class="modal" aria-hidden="true">
        <span class="close" id="modalClose" title="Закрыть">&times;</span>
        <div class="modal-nav">
            <button class="nav-btn prev-btn" id="prevBtn" title="Предыдущее">❮</button>
            <button class="nav-btn next-btn" id="nextBtn" title="Следующее">❯</button>
        </div>
        <img id="modalPhoto" alt="Просмотр фото">
        <div class="image-counter" id="imageCounter"></div>
    </div>
    
    <!-- Новое модальное окно с сеткой фотографий -->
    <div id="photoGridModal" class="modal-grid" aria-hidden="true">
        <div class="modal-grid-content">
            <div class="modal-grid-header">
                <div class="photo-count-info">Фотографии: <span id="photoCount">0</span></div>
                <span class="close-grid" id="gridClose" title="Закрыть">×</span>
            </div>
            
            <!-- <div class="photo-filters">
                <button class="filter-btn active" data-filter="all">Все</button>
                <button class="filter-btn" data-filter="originals">Оригиналы</button>
                <button class="filter-btn" data-filter="checked">Проверка</button>
            </div>
             -->
            <div class="photos-grid-container" id="photosGrid">
                <!-- Фотографии будут вставлены сюда динамически -->
            </div>
        </div>
    </div>
<script>
(() => {
  // --- Конфиг (Jinja подставит URL) ---
  const PAY_PACKAGING_URL = '{{ url_for("pay_packaging") }}' || '/pay-packaging';

  // --- Состояние для модалок фото ---
  let currentPhotoIndex = 0;
  let currentPhotos = [];

  // --- Утилиты ---
  function parsePhotosAttr(photos) {
    if (Array.isArray(photos)) return photos.filter(Boolean);
    if (typeof photos === 'string') {
      const s = photos.trim();
      if (!s) return [];
      try {
        const parsed = JSON.parse(s);
        if (Array.isArray(parsed)) return parsed.filter(Boolean);
        if (typeof parsed === 'string' && parsed) return [parsed];
      } catch (_) {}
      if (s.includes(',')) return s.split(',').map(x => x.trim()).filter(Boolean);
      return [s];
    }
    return [];
  }
  function setBodyScrollDisabled(disabled) {
    document.body.style.overflow = disabled ? 'hidden' : 'auto';
  }
  const $ = sel => document.querySelector(sel);
  const $all = sel => Array.from(document.querySelectorAll(sel));

  // --- Одиночный модал фото ---
  function openPhotoModal(photos, index = 0) {
    const list = parsePhotosAttr(photos);
    if (!list.length) return;
    const modal = $('#photoModal');
    const modalImg = $('#modalPhoto');
    const counter = $('#imageCounter');
    if (!modal || !modalImg || !counter) return;

    currentPhotos = list;
    currentPhotoIndex = Math.max(0, Math.min(Number(index) || 0, currentPhotos.length - 1));
    modalImg.src = currentPhotos[currentPhotoIndex];
    counter.textContent = `${currentPhotoIndex + 1} / ${currentPhotos.length}`;
    modal.style.display = 'block';
    modal.setAttribute('aria-hidden', 'false');
    setBodyScrollDisabled(true);
  }
  function navigatePhoto(direction) {
    if (!currentPhotos.length) return;
    currentPhotoIndex += direction;
    if (currentPhotoIndex < 0) currentPhotoIndex = currentPhotos.length - 1;
    if (currentPhotoIndex >= currentPhotos.length) currentPhotoIndex = 0;
    const modalImg = $('#modalPhoto');
    const counter = $('#imageCounter');
    if (!modalImg || !counter) return;
    modalImg.style.opacity = 0;
    setTimeout(() => {
      modalImg.src = currentPhotos[currentPhotoIndex];
      counter.textContent = `${currentPhotoIndex + 1} / ${currentPhotos.length}`;
      modalImg.style.opacity = 1;
    }, 80);
  }
  function closePhotoModal() {
    const modal = $('#photoModal');
    const modalImg = $('#modalPhoto');
    if (modal) {
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
    }
    currentPhotos = [];
    currentPhotoIndex = 0;
    if (modalImg) modalImg.src = '';
    setBodyScrollDisabled(false);
  }

  // --- Сетка фото ---
  function openPhotoGrid(photos) {
    const list = parsePhotosAttr(photos);
    const modal = $('#photoGridModal');
    const gridContainer = $('#photosGrid');
    const photoCount = $('#photoCount');
    if (!modal || !gridContainer || !photoCount) return;

    gridContainer.innerHTML = '';
    if (!list.length) {
      gridContainer.innerHTML = '<div style="color:#ddd">Нет фотографий</div>';
      photoCount.textContent = '0';
    } else {
      list.forEach((photo, index) => {
        const wrap = document.createElement('div');
        wrap.className = 'grid-photo-item';
        wrap.innerHTML = `
          <img loading="lazy" src="${photo}" alt="Фото товара ${index + 1}">
          <div class="photo-counter">${index + 1}</div>
        `;
        wrap.addEventListener('click', () => openPhotoModal(list, index));
        gridContainer.appendChild(wrap);
      });
      photoCount.textContent = String(list.length);
    }

    modal.style.display = 'block';
    modal.setAttribute('aria-hidden', 'false');
    setBodyScrollDisabled(true);
  }
  function closePhotoGrid() {
    const modal = $('#photoGridModal');
    const gridContainer = $('#photosGrid');
    if (modal) {
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden', 'true');
    }
    if (gridContainer) gridContainer.innerHTML = '';
    setBodyScrollDisabled(false);
  }

  // --- Оплата упаковки ---
  async function payPackaging(shipmentId, amount, btn) {
    try {
      if (!shipmentId) return;
      if (!confirm(`С вашего CNY-баланса будет списано ${amount} CNY за упаковку. Подтвердить?`)) return;
      if (btn) btn.disabled = true;

      const resp = await fetch(PAY_PACKAGING_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ shipment_id: Number(shipmentId) })
      });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok || !data || data.success !== true) {
        alert((data && data.error) ? data.error : 'Не удалось оплатить упаковку');
        if (btn) btn.disabled = false;
        return;
      }
      location.reload();
    } catch (err) {
      console.error(err);
      alert('Сетевая ошибка');
      if (btn) btn.disabled = false;
    }
  }

  // --- Навешивание обработчиков ---
  document.addEventListener('DOMContentLoaded', () => {
    // Миниатюры → одиночный модал
    $all('.shipment-photo').forEach(img => {
      img.addEventListener('click', () => {
        const photosData = img.getAttribute('data-photos');
        const index = img.getAttribute('data-index') || 0;
        openPhotoModal(photosData, index);
      });
    });

    // «Просмотреть все фото» → сетка
    $all('.view-all-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const photosData = btn.getAttribute('data-photos');
        openPhotoGrid(photosData);
      });
    });

    // Закрытия/навигация модалок
    const modalClose = $('#modalClose'); if (modalClose) modalClose.addEventListener('click', closePhotoModal);
    const gridClose  = $('#gridClose');  if (gridClose)  gridClose.addEventListener('click', closePhotoGrid);
    const prevBtn    = $('#prevBtn');    if (prevBtn)    prevBtn.addEventListener('click', () => navigatePhoto(-1));
    const nextBtn    = $('#nextBtn');    if (nextBtn)    nextBtn.addEventListener('click', () => navigatePhoto(1));

    // Оплата упаковки (оба варианта разметки)
    const mountPayHandler = (btn) => {
      btn.addEventListener('click', () => {
        const shipmentId = btn.getAttribute('data-shipment-id');
        const amount = btn.getAttribute('data-amount') || '0.00';
        payPackaging(shipmentId, amount, btn);
      });
    };
    $all('[data-action="pay-packaging"]').forEach(mountPayHandler);
    $all('.btn-pay-packaging').forEach(mountPayHandler);
  });

  // Закрытие модалок кликом по фону
  window.addEventListener('click', (e) => {
    const photoModal = $('#photoModal');
    const gridModal  = $('#photoGridModal');
    if (photoModal && e.target === photoModal) closePhotoModal();
    if (gridModal  && e.target === gridModal)  closePhotoGrid();
  });

  // Горячие клавиши
  document.addEventListener('keydown', (e) => {
    const photoModal = $('#photoModal');
    const gridModal  = $('#photoGridModal');
    const photoShown = photoModal && photoModal.style.display === 'block';
    const gridShown  = gridModal  && gridModal.style.display === 'block';
    if (e.key === 'Escape') {
      if (photoShown) closePhotoModal();
      if (gridShown)  closePhotoGrid();
    } else if (photoShown) {
      if (e.key === 'ArrowLeft')  { navigatePhoto(-1); e.preventDefault(); }
      if (e.key === 'ArrowRight') { navigatePhoto(1);  e.preventDefault(); }
    }
  });

  // Фильтрация (если есть .filter-btn)
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.filter-btn');
    if (!btn) return;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  });
})();
</script>
</body>
</html>
